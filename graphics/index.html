<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
	<link rel="stylesheet" href="https://use.typekit.net/eur4mqo.css">
	<script src="../node_modules/animejs/lib/anime.min.js"></script>
	<script src="../node_modules/fitty/dist/fitty.min.js"></script>
	<style>
		/* variables */
		:root {
			--color-primary: #1976d2;
			--color-secondary: #15315d;
			--color-accent: #ffc400;
			--color-white: #f9f9f9;
			--color-black: #1a1a1a;
			--color-ahead: #99ff99;
			--color-behind: #ff9999;

			--circle-logo-inner-diameter: 70px;
			--circle-logo-outer-diameter: calc(70px + 2pt);

			/* I used math! This percentage is based on the following:
			   1. A width-to-height ratio of 7 to 1
			   2. A slant angle of 15°
			   If the width-to-height ratio changes, this will need to as well.
			   The calculation is tan(t)*h/w to get the percentage of width for the triangle. */
			--trapezoid-ratio: 3.83%;

			/* animations */
			--color-animation-info-transition-leader: var(--color-white);
			--color-animation-info-transition-bg: var(--color-secondary);
			--color-animation-info-transition-text: var(--color-white);
			--color-animation-gold-split-bg: var(--color-accent);
			--color-animation-gold-split-text: var(--color-black);
		}

		/* css reset */
		* {
			padding: 0;
			margin: 0;
		}

		body {
			font-family: sans-serif;
			background:rgba(37, 68, 56, 0.705);
		}

		.monospace {
			font-family: monospace;
		}

		h2 {
			border-bottom: 1px solid rgba(0, 0, 0, 0.205);
		}

		label {
			font-weight: bold;
		}

		/* widget */
		.widget-container {
			margin: 50px 0 0 50px;
			display: inline-block;
		}

		.widget-upper-border {
			position: relative;
			width: 420px;
			height: 60px;
			overflow: visible;
			filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.75));
		}
		.widget-upper-border::after {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			z-index: -2;
			width: 100%;
			height: 100%;
			background-color: var(--color-white);
			clip-path: polygon(0 0, 100% 0, calc(100% - var(--trapezoid-ratio)) 100%, var(--trapezoid-ratio) 100%);
		}

		.widget-upper {
			position: absolute;
			display: flex;
			justify-content: space-between;
			align-items: center;
			top: 1pt;
			left: 1pt;
			width: calc(420px - 2pt);
			height: calc(60px - 2pt);
			color: var(--color-white);
		}
		.widget-upper::after {
			content: '';
			display: block;
			position: absolute;
			top: 0;
			left: 0;
			z-index: -1;
			width: 100%;
			height: 100%;
			background-image: linear-gradient(to right, var(--color-primary), var(--color-black), var(--color-primary));
			clip-path: polygon(0.1% 0, 99.9% 0, calc(100% - var(--trapezoid-ratio)) 100%, var(--trapezoid-ratio) 100%);
		}

		.widget-inner-left,
		.widget-inner-right {
			display: flex;
			position: relative;
			width: 50%;
			height: 100%;
			max-width: calc((100% - var(--trapezoid-ratio) - var(--circle-logo-outer-diameter)) / 2);
			flex-grow: 0;
			white-space: nowrap;
		}
		.widget-inner-left {
			margin-left: calc(var(--trapezoid-ratio) / 2);
			padding-right: calc(var(--circle-logo-outer-diameter) / 2);
			clip-path: polygon(calc(-1 * var(--trapezoid-ratio)) 0, 100% 0, 100% 100%, var(--trapezoid-ratio) 100%);
			flex-direction: row-reverse;
		}
		.widget-inner-right {
			margin-right: calc(var(--trapezoid-ratio) / 2);
			padding-left: calc(var(--circle-logo-outer-diameter) / 2);
			clip-path: polygon(0 0, calc(100% + var(--trapezoid-ratio)) 0, calc(100% - var(--trapezoid-ratio)) 100%, 0 100%);
		}

		.widget-inner-left > div,
		.widget-inner-right > div {
			margin: auto;
		}

		.widget-inner-circle {
			position: absolute;
			left: 50%;
			transform: translateX(-50%);
			width: var(--circle-logo-inner-diameter);
			height: var(--circle-logo-inner-diameter);
			background-color: var(--color-secondary);
			background-image: url("/assets/livesplit/logos/logo_inverted_160x81.png");
			background-position: center;
			background-size: contain;
			background-repeat: no-repeat;
			border-radius: 50%;
			border: 2pt solid var(--color-black);
			box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.75);
		}

		/* widget lower */
		.widget-lower-border {
			position: relative;
			width: 360px;
			height: calc(30px + 2pt);
			z-index: -1;
			filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.75));
			margin: -1pt auto 0;
		}
		.widget-lower-border::after {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			z-index: -2;
			width: 100%;
			height: 100%;
			background-color: var(--color-white);
			/* I used math! These percentages are based on the following:
			   1. A width-to-height ratio of 12 to 1
			   2. A slant angle of 15° (or 85°)
			   If the width-to-height ratio changes, these will need to as well.
			   The calculation is tan(t)*h/w to get the percentage of width for point 4. */
			clip-path: polygon(0 0, 100% 0, 97.77% 100%, 2.23% 100%);
		}

		.widget-lower {
			position: absolute;
			top: 1pt;
			left: 1pt;
			width: calc(360px - 2pt);
			height: 30px;
			color: var(--color-white);
			text-align: center;
			white-space: nowrap;
			background-color: var(--color-black);
			clip-path: polygon(0.1% 0, 99.9% 0, 97.77% 100%, 2.23% 100%);
		}

		/* timers */
		.timer {
			font-family: vox-round, sans-serif;
			font-weight: 600;
			font-style: normal;
			font-size: xx-large;
		}

		.timer-sub {
			font-size: 60%;
		}

		.timer-ahead {
			color: var(--color-ahead);
		}

		.timer-behind {
			color: var(--color-behind);
		}

		/* information displays */
		.text {
			width: 100%;
			height: 100%;
			font-family: apotek-cond, sans-serif;
			font-weight: 300;
			font-style: normal;
			font-size: 24pt;
			line-height: 1em;
			display: flex;
			justify-content: center;
			align-items: center;
		}

		/* p tags within this class will have their font size automatically scaled to fit */
		.shrink-fit {
			height: 75%;
			width: 80%;
			display: flex;
			justify-content: center;
			align-items: center;
		}

		.shrink-fit > p {
			display: inline-block;
			white-space: nowrap;
		}

		.hidden {
			display: none;
		}

		/* animations */
		.animation-container {
			display: flex;
			justify-content: flex-start;
			align-items: center;
			position: absolute;
			width: 100%;
			height: 100%;
			visibility: hidden;
		}

		.widget-inner-left .animation-container {
			margin-right: calc((70px + 2pt) / -2);
			transform: skewX(15deg);
			flex-direction: row-reverse;
		}

		.widget-inner-right .animation-container {
			margin-left: calc((70px + 2pt) / -2);
			transform: skewX(-15deg);
		}

		.transition-box {
			display: flex;
			position: absolute;
			height: 100%;
			justify-content: center;
			align-items: center;
		}

		#widget-full-animations {
			justify-content: center;
			overflow: hidden;
			clip-path: polygon(0 0, 100% 0, calc(100% - var(--trapezoid-ratio)) 100%, var(--trapezoid-ratio) 100%);
			z-index: 2;
		}

		.transition-circle {
			width: var(--circle-logo-inner-diameter);
			height: var(--circle-logo-inner-diameter);
			background-color: transparent;
			border-radius: 50%;
			border: 5px solid var(--color-animation-gold-split-bg);
			margin: auto;
		}

		.transition-circle-full {
			width: var(--circle-logo-inner-diameter);
			height: var(--circle-logo-inner-diameter);
			background-color: var(--color-animation-gold-split-bg);
			border-radius: 50%;
		}

		.transition-box-small {
			width: 15px;
			background-color: var(--color-animation-info-transition-leader);
		}

		.transition-box-large {
			width: 100%;
			background-color: var(--color-animation-info-transition-bg);
			border: 5px solid var(--color-animation-info-transition-leader);
			border-top: none;
			border-bottom: none;
			box-sizing: border-box;
		}

		.widget-inner-left .transition-box {
			transform-origin: right center;
		}

		.widget-inner-right .transition-box {
			transform-origin: left center;
		}

		.transition-box-text {
			color: var(--color-animation-info-transition-text);
			font-weight: 500;
			font-variant: small-caps;
		}

		.transition-box-text-gold {
			color: var(--color-animation-gold-split-text);
			font-weight: 500;
			text-transform: uppercase;
		}
	</style>
</head>
<body>
	<div class="widget-container">
		<div class="widget-upper-border">
			<div class="widget-upper">
				<div id="widget-full-animations" class="animation-container">
					<div class="transition-box transition-circle"></div>
					<div class="transition-box transition-circle"></div>
					<div class="transition-box transition-circle"></div>
					<div class="transition-box transition-circle-full"></div>
					<div class="text">
						<div class="shrink-fit">
							<p class="transition-box-text-gold" id="widget-full-transition-text">GOLD SPLIT!</p>
						</div>
					</div>
				</div>
				<div class="widget-inner-left">
					<div class="widget-left-animations animation-container">
						<div class="transition-box transition-box-small"></div>
						<div class="transition-box transition-box-large">
						</div>
						<div class="text">
							<div class="shrink-fit">
								<p class="transition-box-text" id="widget-left-transition-text"></p>
							</div>
						</div>
					</div>
					<div id="widget-timer-current" class="timer">
						<span class="timer-main">5:09:18</span><span class="timer-sub">.45</span>
					</div>
				</div>
				<div class="widget-inner-right">
					<div class="widget-right-animations animation-container">
						<div class="transition-box transition-box-small"></div>
						<div class="transition-box transition-box-large"></div>
						<div class="text">
							<div class="shrink-fit">
								<p class="transition-box-text" id="widget-right-transition-text"></p>
							</div>
						</div>
					</div>
					<div id="widget-timer-delta" class="timer info-display">
						<span class="timer-main">-4:17</span><span class="timer-sub">.36</span>
					</div>
					<div id="widget-timer-bestPossibleTime" class="timer info-display hidden">
						<span class="timer-main">3:17</span><span class="timer-sub">.72</span>
					</div>
					<div id="widget-timer-finalTime" class="timer info-display hidden">
						<span class="timer-main">9:17:00</span><span class="timer-sub">.72</span>
					</div>
				</div>
				<div class="widget-inner-circle"></div>
			</div>
		</div>
		<div class="widget-lower-border">
			<div class="widget-lower">
				<div class="widget-lower-animations animation-container"></div>
				<div id="widget-info-splitName" class="text">
					<div class="shrink-fit">
						<p>KH2FM - Any% Critical Mode</p>
					</div>
				</div>
			</div>
		</div>
	</div>
	<br />
	<br />
	<br />
	<p id="connection-status"></p>
	<button id="btn-temp-gold-anim">Gold split</button>
	<script>
		/* =================== VARIABLES & SETUP =================== */

		const rLivesplit = nodecg.Replicant('livesplit')
		const rLogos = nodecg.Replicant('assets:logos')
		const infoDisplays = ['delta', 'bestPossibleTime', 'finalTime']
		const animations = [{
			tl: createTransitionTimeline(),
			duration: 2850,
			safeTime: 2850 / 2
		}, {
			tl: createGoldSplitTimeline(),
			duration: 1000
		}]

		let currentInfoIndex = 0

		fitty('.shrink-fit > p', {
			minSize: 12,
			maxSize: 56
		})

		/* =================== REPLICANTS =================== */

		rLivesplit.on('change', (newValue, oldValue) => {
			const connStatus = newValue.connection.status
			document.getElementById('connection-status').textContent = `${connStatus.charAt(0).toUpperCase()}${connStatus.slice(1)} ${connStatus === 'connected' ? 'to' : 'from'} LiveSplit`

			if (newValue.timer) {
				document.querySelector('#widget-timer-current .timer-main').innerText = newValue.timer.currentTime.slice(0, -2)
				document.querySelector('#widget-timer-current .timer-sub').innerText = newValue.timer.currentTime.slice(-2)

				Object.keys(newValue.timer).forEach((k, i) => {
					if (infoDisplays.includes(k)) {
						const query = `#widget-timer-${k}`
						document.querySelector(query + ' .timer-main').innerText = newValue.timer[k].slice(0, -2)
						document.querySelector(query + ' .timer-sub').innerText = newValue.timer[k].slice(-2)
					}
				})

				if (newValue.timer.delta && newValue.timer.delta.charAt(0) === '+') {
					document.getElementById('widget-timer-delta').classList.add('timer-behind')
					document.getElementById('widget-timer-delta').classList.remove('timer-ahead')
				} else {
					document.getElementById('widget-timer-delta').classList.add('timer-ahead')
					document.getElementById('widget-timer-delta').classList.remove('timer-behind')
				}
			}
		})

		// rLogos.on('change', (newValue, oldValue) => {
		// 	document.querySelector('.widget-inner-circle').style.backgroundImage = `url('${newValue[0].url}')`
		// })


		/* =================== MESSAGES =================== */

		nodecg.listenFor('changeInfoDisplay', (_, ack) => {
			changeInfoDisplay(false)
		})

		nodecg.listenFor('split', (segment, ack) => {
			console.log(segment)
		})

		nodecg.listenFor('undoSplit', (segment, ack) => {
			console.log('I would cancel animations here', segment)
		})

		/* =================== ANIMATIONS =================== */

		// on a button for now, but will be wired up to gold splits later
		const btn = document.getElementById('btn-temp-gold-anim')
		btn.onclick = ev => {
			const animation = animations[1]
			document.querySelector('#widget-full-animations').style.visibility = 'visible'
			animation.tl.finished.then(() => {
				document.querySelector('#widget-full-animations').style.visibility = 'hidden'
			})

			animation.tl.play()
		}

		function changeInfoDisplay(playAnimation = true) {
			const animation = animations[0]
			const currentInfo = infoDisplays[currentInfoIndex]
			currentInfoIndex = currentInfoIndex === infoDisplays.length - 1 ? 0 : currentInfoIndex + 1
			const nextInfo = infoDisplays[currentInfoIndex]

			if (playAnimation) {
				document.querySelector('.widget-right-animations').style.visibility = 'visible'
				document.getElementById('widget-right-transition-text').innerText = nextInfo.charAt(0).toUpperCase() + nextInfo.slice(1)
				animation.tl.finished.then(() => {
					document.querySelector('.widget-right-animations').style.visiblity = 'hidden'
				})
				animation.tl.play()
			}

			setTimeout(() => {
				document.getElementById(`widget-timer-${currentInfo}`).classList.add('hidden')
				document.getElementById(`widget-timer-${nextInfo}`).classList.remove('hidden')
			}, animation.safeTime)
		}

		function createTransitionTimeline() {
			const fullWidth = anime.get(document.querySelector('.widget-right-animations'), 'width')
			const easeOut = 'easeOutCubic'
			const easeIn = 'easeInCubic'

			const tl = anime.timeline({
				easing: easeOut,
				autoplay: false
			})

			const smallBoxAnim = {
				targets: '.widget-right-animations .transition-box-small',
				translateX: [
					{ value: fullWidth, duration: 500 },
					{ value: 0, duration: 0 },
					{ value: fullWidth, duration: 500, delay: 1850, easing: easeIn }
				]
			}

			const largeBoxAnim = {
				targets: '.widget-right-animations .transition-box-large',
				width: [
					{ value: [0, '100%'], duration: 500 },
					{ value: 0, duration: 500, delay: 1500, easing: easeIn },
				],
				translateX: [
					{ value: fullWidth, duration: 500, delay: 2000, easing: easeIn }
				]
			}

			const textAnim = {
				targets: '#widget-right-transition-text',
				translateX: [
					{ value: ['-200%', 0], duration: 333 },
					{ value: 20, duration: 1500, easing: 'linear' },
					{ value: '200%', duration: 333, easing: easeIn }
				]
			}

			tl.add(smallBoxAnim).add(largeBoxAnim, 133).add(textAnim, 300)

			return tl
		}

		function createGoldSplitTimeline() {
			const easeOut = 'easeOutCubic'
			const easeIn = 'easeInCubic'

			const tl = anime.timeline({
				easing: easeOut,
				autoplay: false,
				duration: 300
			})

			const logoOut = logoExit()
			const logoIn = {
				targets: '.widget-inner-circle',
				scale: 1,
				duration: 500,
				easing: 'easeOutElastic'
			}

			const pulse = {
				targets: '#widget-full-animations .transition-circle',
				scale: [0, 6],
				opacity: 0,
				delay: anime.stagger(200, { easing: 'easeOutQuad' })
			}

			const fillBoxIn = {
				targets: '#widget-full-animations .transition-circle-full',
				scale: [0, 6]
			}

			const textIn = {
				targets: '#widget-full-animations .text',
				scale: [
					{ value: 0, duration: 0 },
					{ value: 0.9, duration: 300 },
					{ value: 1, duration: 5000, easing: 'linear' }
				],
				opacity: [0, 1]
			}

			const textAndFillBoxOut = {
				targets: ['#widget-full-animations .text', '#widget-full-animations .transition-circle-full'],
				scale: 1.5,
				opacity: 0,
				duration: 1000,
				delay: anime.stagger(500)
			}

			tl.add(logoOut)
			  .add(pulse, '-=500')
			  .add(fillBoxIn, '-=250')
			  .add(textIn, '-=100')
			  .add(textAndFillBoxOut)
			  .add(logoIn, '-=300')

			return tl
		}

		function logoExit() {
			addMotionBlur('.widget-inner-circle')

			// We set this in the CSS classes, but the animation will override it if we don't set it inline
			anime.set('.widget-inner-circle', {
				translateX: '-50%'
			})

			return {
				targets: '.widget-inner-circle',
				// delay: anime.stagger(10),
				scale: [
					{ value: 1, duration: 4000 },
					{ value: 1.5, duration: 1000, easing: 'easeInQuad' },
					{ value: 0, duration: 1000, easing: 'easeInElastic' }
				],
				rotate: [
					{ value: 1080 * 27, duration: 6000, easing: 'easeInExpo', delay: anime.stagger(10) },
				],
				translateX: [
					{ value: '-50%', duration: 4000 },
					{ value: anime.random(-51, -49) + '%', duration: 50 },
					{ value: anime.random(-51, -49) + '%', duration: 50 },
					{ value: anime.random(-51, -49) + '%', duration: 50 },
					{ value: anime.random(-51, -49) + '%', duration: 50 },
					{ value: anime.random(-51, -49) + '%', duration: 50 },
					{ value: anime.random(-51, -49) + '%', duration: 50 },
					{ value: anime.random(-51, -49) + '%', duration: 50 },
					{ value: anime.random(-51, -49) + '%', duration: 50 },
					{ value: anime.random(-51, -49) + '%', duration: 50 },
					{ value: anime.random(-51, -49) + '%', duration: 50 },
					{ value: anime.random(-52, -48) + '%', duration: 50 },
					{ value: anime.random(-52, -48) + '%', duration: 50 },
					{ value: anime.random(-52, -48) + '%', duration: 50 },
					{ value: anime.random(-52, -48) + '%', duration: 50 },
					{ value: anime.random(-52, -48) + '%', duration: 50 },
					{ value: anime.random(-52, -48) + '%', duration: 50 },
					{ value: anime.random(-52, -48) + '%', duration: 50 },
					{ value: anime.random(-52, -48) + '%', duration: 50 },
					{ value: anime.random(-52, -48) + '%', duration: 50 },
					{ value: anime.random(-52, -48) + '%', duration: 50 },
					{ value: anime.random(-53, -47) + '%', duration: 50 },
					{ value: anime.random(-53, -47) + '%', duration: 50 },
					{ value: anime.random(-53, -47) + '%', duration: 50 },
					{ value: anime.random(-53, -47) + '%', duration: 50 },
					{ value: anime.random(-53, -47) + '%', duration: 50 },
					{ value: '-50%', duration: 50 },
					{ value: '-50%', duration: 700 }
				],
				translateY: [
					{ value: 0, duration: 4000 },
					{ value: anime.random(-1, 1) + '%', duration: 50 },
					{ value: anime.random(-1, 1) + '%', duration: 50 },
					{ value: anime.random(-1, 1) + '%', duration: 50 },
					{ value: anime.random(-1, 1) + '%', duration: 50 },
					{ value: anime.random(-1, 1) + '%', duration: 50 },
					{ value: anime.random(-1, 1) + '%', duration: 50 },
					{ value: anime.random(-1, 1) + '%', duration: 50 },
					{ value: anime.random(-1, 1) + '%', duration: 50 },
					{ value: anime.random(-1, 1) + '%', duration: 50 },
					{ value: anime.random(-1, 1) + '%', duration: 50 },
					{ value: anime.random(-2, 2) + '%', duration: 50 },
					{ value: anime.random(-2, 2) + '%', duration: 50 },
					{ value: anime.random(-2, 2) + '%', duration: 50 },
					{ value: anime.random(-2, 2) + '%', duration: 50 },
					{ value: anime.random(-2, 2) + '%', duration: 50 },
					{ value: anime.random(-2, 2) + '%', duration: 50 },
					{ value: anime.random(-2, 2) + '%', duration: 50 },
					{ value: anime.random(-2, 2) + '%', duration: 50 },
					{ value: anime.random(-2, 2) + '%', duration: 50 },
					{ value: anime.random(-2, 2) + '%', duration: 50 },
					{ value: anime.random(-3, 3) + '%', duration: 50 },
					{ value: anime.random(-3, 3) + '%', duration: 50 },
					{ value: anime.random(-3, 3) + '%', duration: 50 },
					{ value: anime.random(-3, 3) + '%', duration: 50 },
					{ value: anime.random(-3, 3) + '%', duration: 50 },
					{ value: 0, duration: 50 },
					{ value: 0, duration: 700 }
				],
				borderColor: [
					{ value: '#f9f9f9', duration: 3000, delay: 1000, easing: 'easeInExpo' },
					{ value: '#ffc400', duration: 1000, delay: 750, easing: 'easeInExpo' },
					{ value: '#1a1a1a', delay: 250 },
				],
				backgroundColor: [
					{ value: '#ffc400', duration: 1000, delay: 5000, easing: 'easeInExpo' },
					{ value: '#15315d' }
				]
			}
		}

		// Creates duplicate elements to simulate motion blur
		function addMotionBlur(selector, steps = 10) {
			const elem = document.querySelector(selector)
			const parent = elem.parentNode
			for (let i = 0; i < steps - 1; i++) {
				const dupe = elem.cloneNode()
				dupe.style.opacity = 1 - 1/steps - i/steps
				dupe.style.boxShadow = 'none'
				parent.appendChild(dupe)
			}
		}
	</script>
</body>
</html>
